<%- include('partials/header') %>

<div class="container" style="margin-top:40px;">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">Thanh to√°n ƒë∆°n ƒë·∫∑t ph√≤ng</h4>
        </div>
        <div class="card-body">
          <% if (typeof status !== 'undefined' && status) { %>
            <div class="alert alert-<%= status === 'success' ? 'success' : 'danger' %> text-center" role="alert">
          <% if (status === 'success') { %>
            üéâ Thanh to√°n MoMo th√†nh c√¥ng! C·∫£m ∆°n b·∫°n ƒë√£ ƒë·∫∑t ph√≤ng.
          <% } else if (status === 'failed') { %>
            ‚ö†Ô∏è Thanh to√°n th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c ch·ªçn ph∆∞∆°ng th·ª©c kh√°c.
          <% } else { %>
            ‚ùå C√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh thanh to√°n.
          <% } %>
        </div>
        <% } %>
          <h5>Th√¥ng tin ƒë∆°n</h5>
          <p>Ph√≤ng: <strong><%= booking.roomId?.name || booking.roomId?.type || booking.roomId?.roomNumber %></strong></p>
          <p>Check-in: <%= new Date(booking.checkIn).toLocaleDateString('vi-VN') %> &nbsp; | &nbsp; Check-out: <%= new Date(booking.checkOut).toLocaleDateString('vi-VN') %></p>
          <p>S·ªë ti·ªÅn: <strong><%= (booking.totalPrice || 0).toLocaleString('vi-VN') %> ƒë</strong></p>
          <hr>

          <h4 class="mt-4 mb-3 fw-bold">Ch·ªçn h√¨nh th·ª©c thanh to√°n</h4>

<form id="paymentForm" action="" method="POST">
  <input type="hidden" name="bookingId" value="<%= booking._id %>">
  <div class="payment-methods text-center mb-3">
    <button type="button" class="btn btn-outline-danger mx-2" id="momo-btn">
      <img src="/images/qrcodes/momo-logo.png" alt="MoMo" style="height: 30px; margin-right: 6px;">
      V√≠ MoMo
    </button>
    <button type="button" class="btn btn-outline-primary mx-2" id="vnpay-btn">
      <img src="/images/qrcodes/vnpay-logo.jpg" alt="VNPay" style="height: 30px; margin-right: 6px;">
      V√≠ VNPay
    </button>
  </div>

  <input type="hidden" id="method" name="method" value="">

  <div id="payMessage" class="text-center mt-3 text-muted"></div>

  <div class="text-center mt-4">
    <button type="submit" class="btn btn-success w-50">X√°c nh·∫≠n</button>
    <a href="/user/history" class="btn btn-secondary w-25">Quay l·∫°i</a>
  </div>
</form>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const momoBtn = document.getElementById('momo-btn');
    const vnpayBtn = document.getElementById('vnpay-btn');
    const methodInput = document.getElementById('method');
    const form = document.getElementById('paymentForm');
    const payMessage = document.getElementById('payMessage');

    // M·∫∑c ƒë·ªãnh ch∆∞a ch·ªçn g√¨
    methodInput.value = "";

    // X·ª≠ l√Ω ch·ªçn ph∆∞∆°ng th·ª©c
    momoBtn.addEventListener('click', () => {
      methodInput.value = 'momo';
      momoBtn.classList.add('btn-danger');
      vnpayBtn.classList.remove('btn-primary');
      payMessage.innerHTML = '<span class="text-primary">B·∫°n ƒë√£ ch·ªçn thanh to√°n qua <b>MoMo</b>.</span>';
    });

    vnpayBtn.addEventListener('click', () => {
      methodInput.value = 'vnpay';
      vnpayBtn.classList.add('btn-primary');
      momoBtn.classList.remove('btn-danger');
      payMessage.innerHTML = '<span class="text-primary">B·∫°n ƒë√£ ch·ªçn thanh to√°n qua <b>VNPay</b>.</span>';
    });

    // X·ª≠ l√Ω n√∫t X√°c nh·∫≠n
    form.addEventListener('submit', async (e) => {
  e.preventDefault(); // NgƒÉn form reload trang
  const method = methodInput.value;
  const bookingId = '<%= booking._id %>';
  const confirmButton = form.querySelector('button[type="submit"]');

  if (confirmButton.disabled) return; // ‚õî Tr√°nh double-click
  confirmButton.disabled = true;
  payMessage.innerHTML = '';

  if (!method) {
    payMessage.innerHTML = '<span class="text-danger">‚ö†Ô∏è Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n tr∆∞·ªõc khi x√°c nh·∫≠n!</span>';
    confirmButton.disabled = false;
    return;
  }

  // ===== N·∫øu ch·ªçn MOMO =====
  if (method === 'momo') {
    payMessage.innerHTML = '<span class="text-primary">‚è≥ ƒêang chuy·ªÉn sang trang thanh to√°n MoMo...</span>';
    try {
      const response = await fetch('/payment/momo/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bookingId })
      });

      // ‚ö†Ô∏è ƒêo·∫°n n√†y ƒë·ªïi t·ª´ redirect server ‚Üí tr·∫£ JSON payUrl
      const data = await response.json();
      if (data.payUrl) {
        window.location.href = data.payUrl; // üëâ M·ªü trang QR MoMo
      } else {
        payMessage.innerHTML = '<span class="text-danger">Kh√¥ng th·ªÉ m·ªü trang thanh to√°n MoMo.</span>';
      }
    } catch (err) {
      console.error(err);
      payMessage.innerHTML = '<span class="text-danger">L·ªói khi kh·ªüi t·∫°o thanh to√°n MoMo.</span>';
    } finally {
      confirmButton.disabled = false;
    }
  }

  // ===== N·∫øu ch·ªçn VNPAY =====
  else if (method === 'vnpay') {
    payMessage.innerHTML = '<span class="text-warning">‚ö†Ô∏è VNPay ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn, vui l√≤ng ch·ªçn MoMo ƒë·ªÉ test.</span>';
    confirmButton.disabled = false;
  }
});
  });
</script>

<%- include('partials/footer') %>
