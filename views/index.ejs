<%- include('partials/header') %>

<!-- SwiperJS CDN -->
<link rel="stylesheet" href="https://unpkg.com/swiper@10/swiper-bundle.min.css" />
<script src="https://unpkg.com/swiper@10/swiper-bundle.min.js"></script>

<style>
  /* Tinh chỉnh nhỏ cho phần 'Khám phá theo loại phòng' */
  .discover-section { background:#f8fbff; padding:34px 0; }
  .discover-grid { display:flex; gap:28px; align-items:flex-start; }
  .discover-left { flex:1.2; }
  .discover-right { flex:1; display:flex; flex-direction:column; gap:14px; }
  .discover-img { width:100%; height:380px; object-fit:cover; border-radius:14px; box-shadow:0 12px 36px rgba(2,132,199,.08); transition:all .35s ease; }
  .type-chip { border-radius:999px; padding:.45rem .8rem; border:1px solid #c7e9ff; background:transparent; color:#0369a1; cursor:pointer; transition:.18s; }
  .type-chip.active { background:#0ea5e9; color:#fff; border-color:#0ea5e9; box-shadow:0 10px 28px rgba(14,165,233,.12); transform:translateY(-3px); }
  .type-card { background:#fff; padding:12px; border-radius:12px; box-shadow:0 10px 22px rgba(2,132,199,.04); display:flex; gap:12px; align-items:flex-start; transition:.18s; }
  .type-card:hover { transform:translateY(-6px); box-shadow:0 18px 40px rgba(2,132,199,.10); }
  .type-icon { width:56px; height:56px; border-radius:12px; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,#e6f7ff,#dbeafe); color:#0369a1; font-weight:700; }
  @media (max-width:980px) {
    .discover-grid { flex-direction:column; }
    .discover-img { height:220px; }
  }

  /* ===== Discounts styles embedded here so index loads correctly if css not updated yet ===== */
  .discounts-section {
    padding: 36px 0 18px;
    background: transparent;
  }
  .discounts-section .section-title {
    color: #1778ff;
    font-size: 26px;
    margin-bottom: 18px;
    font-weight: 700;
  }

  .discount-inner {
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .discount-code { font-size: 18px; font-weight:700; color:#0f6fa8; }
  /* sửa: chữ phần trăm trắng, đặt nền gradient */
  .discount-percent {
    background: linear-gradient(90deg,#00c3ff,#0078ff);
    color: #ffffff;
    font-size:14px;
    font-weight:800;
    padding: 8px 12px;
    border-radius: 8px;
    width: 72px;
    text-align: center;
  }
  .discount-dates { color:#6b7b85; font-size:13px; }
  .discount-cta { margin-top:10px; display:flex; justify-content:flex-end; }
  .btn-apply { cursor:pointer; padding:8px 12px; border-radius:6px; border:none; background:#0ea5e9; color:#fff; }
  .btn-apply:active { transform:translateY(1px); }
  .no-discounts { color:#6b7280; padding:12px 0; }


</style>

<!-- HERO BANNER SECTION -->
<section class="hero-banner" style="background-image: url('/images/banner1.jpg');">
  <div class="overlay"></div>
  <div class="hero-content container text-center text-white">
    <h1 class="fw-bold display-4 mb-3">Tận hưởng kỳ nghỉ hoàn hảo cùng chúng tôi</h1>
    <p class="lead mb-4">Đặt phòng dễ dàng – Ưu đãi hấp dẫn – Trải nghiệm đẳng cấp</p>

    <!-- Search form -->
    <form action="/search" method="get" class="search-box row justify-content-center g-2 p-3 bg-white rounded-4 shadow-lg">
      <div class="col-md-3 col-12">
        <input class="form-control" type="text" name="q" placeholder="Từ khóa (Deluxe, D101, ...)" />
      </div>
      <div class="col-md-2 col-6">
        <select class="form-select" name="type">
          <option value="">Tất cả loại phòng</option>
          <option value="Standard">Standard</option>
          <option value="Superior">Superior</option>
          <option value="Deluxe">Deluxe</option>
          <option value="Suite">Suite</option>
        </select>
      </div>
      <div class="col-md-2 col-6">
        <input class="form-control" type="date" name="checkIn" placeholder="Nhận phòng" />
      </div>
      <div class="col-md-2 col-6">
        <input class="form-control" type="date" name="checkOut" placeholder="Trả phòng" />
      </div>
      <div class="col-md-2 col-6">
        <button type="submit" class="btn btn-accent w-100 fw-bold">Tìm phòng</button>
      </div>
    </form>
  </div>
</section>


<!-- ======= ƯU ĐÃI CỦA CHÚNG TÔI ======= -->
<section class="discounts-section">
  <div class="container">
    <h2 class="section-title">Ưu đãi của chúng tôi</h2>

    <div class="swiper discount-swiper">
      <div class="swiper-wrapper">
        <% discounts.forEach(discount => { %>
          <div class="swiper-slide">
            <div class="discount-card">
              <div class="discount-header">
                <span class="discount-percent"><%= discount.percent %>%</span>
                <% const valid = new Date() <= new Date(discount.endDate); %>
                <% if (valid) { %>
                  <span class="discount-status active">Còn hiệu lực</span>
                <% } else { %>
                  <span class="discount-status expired">Hết hạn</span>
                <% } %>
              </div>
              <p class="discount-code">Mã: <%= discount.code %></p>
              <p class="discount-date">
                Từ <%= discount.startDate.toLocaleDateString('vi-VN') %> -
                <%= discount.endDate.toLocaleDateString('vi-VN') %>
              </p>
              <button class="copy-btn" onclick="copyCode('<%= discount.code %>')">Sao chép mã</button>
            </div>
          </div>
        <% }) %>
      </div>

      <!-- Nút điều hướng -->
      <div class="swiper-button-prev"></div>
      <div class="swiper-button-next"></div>
    </div>
  </div>
</section>

<!-- Swiper setup -->
<script>
  window.addEventListener("load", () => {
    new Swiper(".discount-swiper", {
      slidesPerView: 3,
      spaceBetween: 40,
      grabCursor: true,
      loop: false,
      navigation: {
        nextEl: ".swiper-button-next",
        prevEl: ".swiper-button-prev",
      },
      breakpoints: {
        0: { slidesPerView: 1 },
        768: { slidesPerView: 2 },
        1200: { slidesPerView: 3 },
      },
    });
  });

  function copyCode(code) {
    navigator.clipboard.writeText(code);
    alert("Đã sao chép mã: " + code);
  }
</script>


<!-- Khám phá theo loại phòng -->
<section class="discover-section container my-5">
  <h3 class="section-title mb-4">Khám phá theo loại phòng</h3>

  <div class="discover-container">
    <!-- Cột ảnh bên trái -->
    <div class="discover-left text-center">
  <img id="roomImage" src="" alt="Ảnh loại phòng" class="room-preview hidden">
  <div id="viewAllContainer" class="hidden">
    <a id="viewAllButton" href="#" class="btn btn-outline-primary btn-sm mt-3 rounded-pill">
      Xem tất cả phòng
    </a>
  </div>
</div>

    <!-- Cột nội dung bên phải -->
    <div class="discover-right">

      <div class="room-type-card" data-type="standard">
        <div class="room-type-header">
          <div class="type-left">
            <div class="type-icon">S</div>
            <div>
              <h5>Standard <span class="badge bg-light text-dark fw-normal">Hạng cơ bản</span></h5>
              <p class="text-muted small mb-0">Hạng cơ bản, diện tích vừa phải, tiện nghi tiêu chuẩn. Phù hợp cho khách muốn tiết kiệm.</p>
            </div>
          </div>
          <button class="toggle-btn"><i class="bi bi-chevron-down"></i></button>
        </div>
        <div class="room-type-body">
          <ul>
            <li>Diện tích: 25–30m²</li>
            <li>Giường: 1 Queen hoặc 2 Single</li>
            <li>Tiện nghi: Wifi, TV, máy lạnh, minibar...</li>
          </ul>
        </div>
      </div>

      <div class="room-type-card" data-type="superior">
        <div class="room-type-header">
          <div class="type-left">
            <div class="type-icon">SP</div>
            <div>
              <h5>Superior <span class="badge bg-light text-dark fw-normal">Hạng trung</span></h5>
              <p class="text-muted small mb-0">Phòng rộng hơn, trang trí đẹp, phù hợp khách công tác và cặp đôi.</p>
            </div>
          </div>
          <button class="toggle-btn"><i class="bi bi-chevron-down"></i></button>
        </div>
        <div class="room-type-body">
          <ul>
            <li>Diện tích: 35–40m²</li>
            <li>Giường: 1 King hoặc 2 Twin</li>
            <li>Tiện nghi: Bàn làm việc, view thành phố, bồn tắm...</li>
          </ul>
        </div>
      </div>

      <div class="room-type-card" data-type="deluxe">
        <div class="room-type-header">
          <div class="type-left">
            <div class="type-icon">DX</div>
            <div>
              <h5>Deluxe <span class="badge bg-light text-dark fw-normal">Hạng cao</span></h5>
              <p class="text-muted small mb-0">View đẹp, nội thất cao cấp hơn, phù hợp khách du lịch muốn trải nghiệm.</p>
            </div>
          </div>
          <button class="toggle-btn"><i class="bi bi-chevron-down"></i></button>
        </div>
        <div class="room-type-body">
          <ul>
            <li>Diện tích: 40–50m²</li>
            <li>Giường: 1 King</li>
            <li>Tiện nghi: Ban công, sofa, máy pha cà phê...</li>
          </ul>
        </div>
      </div>

      <div class="room-type-card" data-type="suite">
        <div class="room-type-header">
          <div class="type-left">
            <div class="type-icon">ST</div>
            <div>
              <h5>Suite <span class="badge bg-light text-dark fw-normal">Hạng sang</span></h5>
              <p class="text-muted small mb-0">Phòng sang trọng, có phòng khách riêng và dịch vụ cao cấp.</p>
            </div>
          </div>
          <button class="toggle-btn"><i class="bi bi-chevron-down"></i></button>
        </div>
        <div class="room-type-body">
          <ul>
            <li>Diện tích: 70–100m²</li>
            <li>Giường: 1 King</li>
            <li>Tiện nghi: Phòng khách riêng, view toàn cảnh...</li>
          </ul>
        </div>
      </div>

    </div>
  </div>
</section>


<!-- Featured rooms (enhanced: supports filename / uploads path / full url, shows availability badges) -->
<section class="container py-5">
  <h3 class="text-primary fw-bold mb-3">Phòng nổi bật</h3>

  <div class="row g-4">
    <% if (rooms && rooms.length) { %>
      <% rooms.forEach(function(r){ 
           // compute imagePath safely:
           let imgPath = '/images/room1.jpeg'; // default
           if (r.image) {
             const img = String(r.image || '').trim();
             const isUrl = img.startsWith('http://') || img.startsWith('https://');
             if (isUrl) {
               imgPath = img;
             } else if (img.startsWith('/')) {
               imgPath = img; // already absolute path
             } else if (img.indexOf('/') !== -1) {
               // contains slash but not starting with slash -> ensure leading slash
               imgPath = img.startsWith('uploads/') ? '/' + img : '/' + img;
             } else {
               // filename only -> assume stored in public/uploads/rooms/
               imgPath = '/uploads/rooms/' + img;
             }
           }

           // determine availability flags (order of precedence)
           // 1) if search page provided isAvailableForRange (true/false) -> use it
           // 2) else if homepage annotated isAvailableToday -> use it
           // 3) else undefined (assume available)
           let isAvailable = true;
           if (typeof r.isAvailableForRange !== 'undefined' && r.isAvailableForRange !== null) {
             isAvailable = !!r.isAvailableForRange;
           } else if (typeof r.isAvailableToday !== 'undefined' && r.isAvailableToday !== null) {
             isAvailable = !!r.isAvailableToday;
           } else {
             isAvailable = true;
           }
      %>
        <div class="col-sm-6 col-lg-4">
          <% if (isAvailable) { %>
            <a href="/user/room/<%= r._id %>" class="text-decoration-none text-dark">
          <% } else { %>
            <div class="text-decoration-none text-dark">
          <% } %>
            <div class="card room-card h-100 border-0 shadow-sm rounded-4 position-relative <%= isAvailable ? '' : 'room-card-disabled' %>">
              <img src="<%= imgPath %>" class="card-img-top rounded-top-4" style="height:220px;object-fit:cover" alt="room" onerror="this.src='/images/room1.jpeg'">
              <div class="card-body">
                <h6 class="fw-bold mb-1"><%= r.name || (r.type + ' - ' + r.roomNumber) %></h6>
                <div class="d-flex justify-content-between align-items-center">
                  <div class="text-info fw-bold"><%= (r.price||0).toLocaleString() %>₫/đêm</div>
                  <div class="small text-muted"><%= r.type || '' %></div>
                </div>
              </div>

              <div class="card-footer bg-transparent border-0 d-flex justify-content-between align-items-center">
                <div>
                  <% if (typeof r.isAvailableForRange !== 'undefined' && r.isAvailableForRange !== null) { %>
                    <% if (r.isAvailableForRange) { %>
                      <span class="badge bg-success">Trống cho ngày đã chọn</span>
                    <% } else { %>
                      <span class="badge bg-danger">Bận trong khoảng đã chọn</span>
                    <% } %>
                  <% } else if (typeof r.isAvailableToday !== 'undefined' && r.isAvailableToday !== null) { %>
                    <% if (r.isAvailableToday) { %>
                      <span class="badge bg-success">Trống hôm nay</span>
                    <% } else { %>
                      <span class="badge bg-warning text-dark">Có khách hôm nay</span>
                    <% } %>
                  <% } %>
                </div>

                <div>
                  <% if (isAvailable) { %>
                    <a class="btn btn-primary btn-sm" href="/user/room/<%= r._id %>">Xem & Đặt</a>
                  <% } else { %>
                    <button class="btn btn-secondary btn-sm" disabled>Không khả dụng</button>
                  <% } %>
                </div>
              </div>

            </div>
          <% if (isAvailable) { %>
            </a>
          <% } else { %>
            </div>
          <% } %>
        </div>
      <% }) %>
    <% } else { %>
      <div class="col-12 text-muted">Hiện chưa có phòng khả dụng.</div>
    <% } %>
  </div>
</section>
<%- include('partials/footer') %>

<script>
  document.addEventListener("DOMContentLoaded",function(){
    const imgs = {
      standard: '/images/Standard.jpg',
      superior: '/images/Superior.jpg',
      deluxe: '/images/Deluxe.jpg',
      suite: '/images/Suite.jpg'
    };
    document.querySelectorAll('.type-chip').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.type-chip').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const key = btn.dataset.key;
        const img = document.getElementById('discoverMainImg');
        if(img){
          img.style.opacity = 0;
          setTimeout(()=>{ img.src = imgs[key] || '/images/room-explore.jpg'; img.style.opacity = 1; }, 180);
        }
      });
    });

    const today = new Date().toISOString().split('T')[0];
    const inEl = document.getElementById('checkIn');
    const outEl = document.getElementById('checkOut');
    if(inEl) inEl.min = today;
    if(outEl) outEl.min = today;
    if(inEl && outEl) inEl.addEventListener('change', ()=> outEl.min = inEl.value || today);

    // Clipboard copy for discount codes
    document.addEventListener('click', function(e){
      const el = e.target;
      if (el && el.classList.contains('btn-apply')) {
        const code = el.getAttribute('data-code');
        if (!code) return;
        navigator.clipboard && navigator.clipboard.writeText(code).then(()=>{
          const old = el.innerText;
          el.innerText = 'Đã sao chép';
          setTimeout(()=> el.innerText = old, 1400);
        }).catch(err=>{
          console.error('Copy failed', err);
          alert('Không thể sao chép tự động, vui lòng sao chép thủ công: ' + code);
        });
      }
    });

    // SwiperJS init for discounts
new Swiper(".discount-swiper", {
  slidesPerView: 3,
  spaceBetween: 30,
  grabCursor: true,
  loop: false,
  navigation: {
    nextEl: ".swiper-button-next",
    prevEl: ".swiper-button-prev",
  },
  breakpoints: {
    0: { slidesPerView: 1 },
    768: { slidesPerView: 2 },
    1200: { slidesPerView: 3 },
  },
});
  });
</script>
