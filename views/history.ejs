<%- include('partials/header') %>

<div class="container my-5 pt-5">
  <h3 class="mb-4">Lịch sử đặt phòng</h3>

  <% if (!bookings || bookings.length === 0) { %>
    <div class="alert alert-info">Bạn chưa có đơn đặt phòng nào.</div>
  <% } else { %>
    <div class="row g-3">
      <% bookings.forEach(function(b) {
          const checkIn = new Date(b.checkIn || b.createdAt);
          const checkOut = new Date(b.checkOut || b.createdAt);
          const nights = Math.max(1, Math.round((checkOut - checkIn) / (1000*60*60*24)));
          const price = Number(b.totalPrice || 0);
          const status = (b.status || 'pending').toLowerCase();
          let statusText = 'Chờ xác nhận';
          if (status === 'paid') statusText = 'Đã thanh toán';
          else if (status === 'confirmed') statusText = 'Đã xác nhận';
          else if (status === 'checked_in') statusText = 'Đã nhận phòng';
          else if (status === 'checked_out') statusText = 'Đã trả phòng';
          else if (status === 'cancelled') statusText = 'Đã hủy';
      %>
        <div class="col-12">
          <div class="history-card shadow-sm rounded d-flex align-items-center p-3 bg-white">
            <div class="col-md-2 d-flex align-items-center justify-content-center">
              <img 
                src="<%= b.roomId?.image || '/images/default-room.jpg' %>" 
                alt="<%= b.roomId?.name || 'Phòng không xác định' %>" 
                class="img-fluid rounded shadow-sm" 
                style="width: 120px; height: 90px; object-fit: cover;"
              >
            </div>

            <div class="flex-grow-1">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h5 class="mb-1 fw-bold">
                    <%= b.roomId?.roomNumber || b.roomId?.name || 'Phòng' %>
                    <small class="text-muted ms-2">· <%= b.roomId?.type || '' %></small>
                  </h5>
                  <div class="text-muted small">
                    <span>Check-in: <strong><%= checkIn.toLocaleDateString('vi-VN') %></strong></span>
                    <span class="mx-2">|</span>
                    <span>Check-out: <strong><%= checkOut.toLocaleDateString('vi-VN') %></strong></span>
                    <span class="mx-2">|</span>
                    <span>Số đêm: <strong><%= nights %></strong></span>
                  </div>
                </div>

                <div class="text-end">
                  <div class="mb-2">
                    <% 
                      let badgeClass = 'badge bg-secondary';
                      if (status === 'paid') badgeClass = 'badge bg-success';
                      else if (status === 'confirmed' || status === 'checked_in') badgeClass = 'badge bg-primary';
                      else if (status === 'cancelled') badgeClass = 'badge bg-danger';
                      else if (status === 'checked_out') badgeClass = 'badge bg-info';
                    %>
                    <span class="<%= badgeClass %> px-3 py-2" style="font-size:0.9rem;"><%= statusText %></span>
                  </div>

                  <div class="fw-semibold text-dark" style="font-size:1.05rem;">
                    <%= price.toLocaleString('vi-VN') %> đ
                  </div>
                </div>
              </div>

              <% if (b.roomId?.description) { %>
                <p class="mb-2 mt-2 text-muted small"><%= b.roomId.description %></p>
              <% } %>

              <div class="mt-3 d-flex gap-2 justify-content-end">
                <!-- Nút mở modal Chi tiết -->
                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#detailModal<%= b._id %>">
                  Chi tiết
                </button>

                <% 
                  const disallowedPayment = ['paid','checked_in','checked_out','confirmed','cancelled'];
                  const canPay = !disallowedPayment.includes(status);
                %>

                <% if (canPay) { %>
                  <a class="btn btn-success btn-sm" href="/payment/user?bookingId=<%= b._id %>">Thanh toán</a>
                <% } %>

                <% if (status === 'checked_out') { %>
                  <a href="/review/<%= b.roomId._id %>" class="btn btn-warning btn-sm">Đánh giá phòng</a>
                <% } %>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal hiển thị chi tiết -->
        <div class="modal fade" id="detailModal<%= b._id %>" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Chi tiết đặt phòng</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
              </div>
              <div class="modal-body">
                <p><strong>Phòng:</strong> <%= b.roomId?.type %> - <%= b.roomId?.roomNumber %></p>
                <p><strong>Giá tiền:</strong> <%= b.totalPrice.toLocaleString('vi-VN') %> đ</p>
                <p><strong>Trạng thái:</strong> <%= statusText %></p>
                <p><strong>Check-in:</strong> <%= checkIn.toLocaleDateString('vi-VN') %></p>
                <p><strong>Check-out:</strong> <%= checkOut.toLocaleDateString('vi-VN') %></p>
                <p><strong>Số đêm:</strong> <%= nights %></p>
                <p><strong>Số khách:</strong> <%= b.guests || 1 %></p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
              </div>
            </div>
          </div>
        </div>

      <% }) %>
    </div>
  <% } %>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<%- include('partials/footer') %>
