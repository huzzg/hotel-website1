<%- include('partials/header') %>

<div class="container my-5 pt-5">
  <h3 class="mb-4">L·ªãch s·ª≠ ƒë·∫∑t ph√≤ng</h3>

  <% if (!bookings || bookings.length === 0) { %>
    <div class="alert alert-info">B·∫°n ch∆∞a c√≥ ƒë∆°n ƒë·∫∑t ph√≤ng n√†o.</div>
  <% } else { %>
    <div class="row g-3">
      <% bookings.forEach(function(b) {
          const checkIn = new Date(b.checkIn || b.createdAt);
          const checkOut = new Date(b.checkOut || b.createdAt);
          const nights = Math.max(1, Math.round((checkOut - checkIn) / (1000*60*60*24)));
          const price = Number(b.totalPrice || 0);
          const status = (b.status || 'pending').toLowerCase();
          let statusText = 'Ch·ªù x√°c nh·∫≠n';
          if (status === 'paid') statusText = 'ƒê√£ thanh to√°n';
          else if (status === 'confirmed') statusText = 'ƒê√£ x√°c nh·∫≠n';
          else if (status === 'checked_in') statusText = 'ƒê√£ nh·∫≠n ph√≤ng';
          else if (status === 'checked_out') statusText = 'ƒê√£ tr·∫£ ph√≤ng';
          else if (status === 'cancelled') statusText = 'ƒê√£ h·ªßy';

          // ‚úÖ X√°c ƒë·ªãnh ƒë∆∞·ªùng d·∫´n ·∫£nh an to√†n
          let imgPath = '/images/default-room.jpg';
          if (b.roomId && b.roomId.image) {
            const img = b.roomId.image;
            if (img.startsWith('http://') || img.startsWith('https://')) imgPath = img;
            else if (img.startsWith('/')) imgPath = img;
            else imgPath = '/uploads/rooms/' + img;
          }
      %>

      <div class="col-12">
        <div class="history-card shadow-sm rounded d-flex align-items-center p-3 bg-white">
          <div class="col-md-2 d-flex align-items-center justify-content-center">
            <img 
              src="<%= imgPath %>"
              alt="<%= b.roomId?.name || 'Ph√≤ng kh√¥ng x√°c ƒë·ªãnh' %>" 
              class="img-fluid rounded shadow-sm" 
              style="width: 120px; height: 90px; object-fit: cover;"
            >
          </div>

          <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h5 class="mb-1 fw-bold">
                  <%= b.roomId?.roomNumber || b.roomId?.name || 'Ph√≤ng' %>
                  <small class="text-muted ms-2">¬∑ <%= b.roomId?.type || '' %></small>
                </h5>
                <div class="text-muted small">
                  <span>Check-in: <strong><%= checkIn.toLocaleDateString('vi-VN') %></strong></span>
                  <span class="mx-2">|</span>
                  <span>Check-out: <strong><%= checkOut.toLocaleDateString('vi-VN') %></strong></span>
                  <span class="mx-2">|</span>
                  <span>S·ªë ƒë√™m: <strong><%= nights %></strong></span>
                </div>
              </div>

              <div class="text-end">
                <div class="mb-2">
                  <%
                    var badgeClass = 'badge bg-secondary';
                    if (status === 'paid') badgeClass = 'badge bg-success';
                    else if (status === 'confirmed' || status === 'checked_in') badgeClass = 'badge bg-primary';
                    else if (status === 'cancelled') badgeClass = 'badge bg-danger';
                    else if (status === 'checked_out') badgeClass = 'badge bg-info';
                  %>
                  <span class="<%= badgeClass %> px-3 py-2" style="font-size:0.9rem;"><%= statusText %></span>
                </div>

                <div class="fw-semibold text-dark" style="font-size:1.05rem;">
                  <%= price.toLocaleString('vi-VN') %> ƒë
                </div>
              </div>
            </div>

            <% if (b.roomId?.description) { %>
              <p class="mb-2 mt-2 text-muted small"><%= b.roomId.description %></p>
            <% } %>

            <div class="mt-3 d-flex gap-2 justify-content-end">
              <!-- N√∫t m·ªü modal Chi ti·∫øt -->
              <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#detailModal<%= b._id %>">
                Chi ti·∫øt
              </button>

              <% 
                const disallowedPayment = ['paid','checked_in','checked_out','confirmed','cancelled'];
                const canPay = !disallowedPayment.includes(status);
              %>

              <% if (canPay) { %>
                <a class="btn btn-success btn-sm" href="/payment/user?bookingId=<%= b._id %>">Thanh to√°n</a>
              <% } %>

              <% if (status === 'checked_out') { %>
                <a href="/review/<%= b.roomId._id %>" class="btn btn-warning btn-sm">ƒê√°nh gi√° ph√≤ng</a>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL: Chi ti·∫øt ƒë·∫∑t ph√≤ng -->
      <div class="modal fade" id="detailModal<%= b._id %>" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content shadow-lg border-0 rounded-4">
            <div class="modal-header bg-primary text-white rounded-top-4">
              <h5 class="modal-title fw-bold">
                <i class="bi bi-info-circle me-2"></i> Chi ti·∫øt ƒë·∫∑t ph√≤ng
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
              <div class="row">
                <div class="col-md-5 text-center">
                  <img src="<%= imgPath %>" class="img-fluid rounded-4 shadow-sm mb-3"
                       alt="·∫¢nh ph√≤ng" style="width:100%; max-height:250px; object-fit:cover;">
                </div>
                <div class="col-md-7">
                  <table class="table table-borderless">
                    <tbody>
                      <tr><th>üè® Ph√≤ng:</th><td><%= b.roomId?.name || b.roomId?.type %></td></tr>
                      <tr><th>üí∞ Gi√°:</th><td><%= (b.totalPrice || 0).toLocaleString('vi-VN') %>‚Ç´</td></tr>
                      <tr><th>üìÖ Check-in:</th><td><%= new Date(b.checkIn).toLocaleDateString('vi-VN') %></td></tr>
                      <tr><th>üìÜ Check-out:</th><td><%= new Date(b.checkOut).toLocaleDateString('vi-VN') %></td></tr>
                      <tr><th>üë• S·ªë kh√°ch:</th><td><%= b.guests || 1 %></td></tr>
                      <tr>
                        <th>üîñ Tr·∫°ng th√°i:</th>
                        <td>
                          <%
                            var badgeClass = 'badge bg-secondary';
                            if (b.status === 'paid') badgeClass = 'badge bg-success';
                            else if (b.status === 'cancelled') badgeClass = 'badge bg-danger';
                            else if (b.status === 'checked_in') badgeClass = 'badge bg-primary';
                            else if (b.status === 'checked_out') badgeClass = 'badge bg-info';
                          %>
                          <span class="<%= badgeClass %> fs-6"><%= statusText %></span>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="modal-footer d-flex justify-content-between">
              <button class="btn btn-success btnSendEmail" data-booking-id="<%= b._id %>">
                <i class="bi bi-envelope"></i> G·ª≠i th√¥ng tin qua Email
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
          </div>
        </div>
      </div>
      <% }) %>
    </div>
  <% } %>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".btnSendEmail").forEach(btn => {
    btn.addEventListener("click", async () => {
      const bookingId = btn.dataset.bookingId;
      const res = await fetch("/user/send-booking-email", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ bookingId })
      });
      const data = await res.json();
      alert(data.message || "ƒê√£ g·ª≠i email!");
    });
  });
});
</script>

<%- include('partials/footer') %>
